<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tutor-Learner Messaging Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-step {
            margin: 15px 0;
            padding: 10px;
            border-left: 4px solid #007bff;
            background-color: #f8f9fa;
        }
        .expected {
            color: #28a745;
            font-weight: bold;
        }
        .warning {
            color: #ffc107;
            font-weight: bold;
        }
        .error {
            color: #dc3545;
            font-weight: bold;
        }
        .success {
            color: #28a745;
            font-weight: bold;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .status.success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .status.error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .status.warning {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
    </style>
</head>
<body>
    <h1>üß™ Tutor-Learner Messaging System Test</h1>
    
    <div class="test-container">
        <h2>üìã Pre-Test Checklist</h2>
        <div class="test-step">
            <input type="checkbox" id="backend-running"> Backend server running on port 5000
        </div>
        <div class="test-step">
            <input type="checkbox" id="frontend-running"> Frontend running on port 5173
        </div>
        <div class="test-step">
            <input type="checkbox" id="database-connected"> MongoDB database connected
        </div>
        <div class="test-step">
            <input type="checkbox" id="tutor-account"> Tutor account created with courses
        </div>
        <div class="test-step">
            <input type="checkbox" id="learner-account"> Learner account created and enrolled
        </div>
        <div class="test-step">
            <input type="checkbox" id="browser-setup"> Two browsers/incognito windows ready
        </div>
    </div>

    <div class="test-container">
        <h2>üîç Quick System Check</h2>
        <button onclick="checkBackend()">Check Backend Status</button>
        <button onclick="checkFrontend()">Check Frontend Status</button>
        <button onclick="checkWebSocket()">Check WebSocket Connection</button>
        <div id="system-status"></div>
    </div>

    <div class="test-container">
        <h2>üì± Test Scenarios</h2>
        
        <h3>Test 1: Basic Message Flow</h3>
        <div class="test-step">
            <strong>1.1 Tutor to Learner Message:</strong><br>
            ‚Ä¢ Login as tutor ‚Üí Navigate to messaging ‚Üí Select learner ‚Üí Start conversation<br>
            ‚Ä¢ Send: "Hello [Learner Name], how are you doing with the assignment?"<br>
            <span class="expected">Expected: Message appears immediately in tutor's chat</span>
        </div>
        
        <div class="test-step">
            <strong>1.2 Verify on Learner Side:</strong><br>
            ‚Ä¢ Login as learner (different browser) ‚Üí Navigate to messaging ‚Üí Select tutor<br>
            <span class="expected">Expected: Tutor's message visible + notification appears</span>
        </div>
        
        <div class="test-step">
            <strong>1.3 Learner to Tutor Reply:</strong><br>
            ‚Ä¢ Send: "Hi [Tutor Name], I'm doing well. I have a question about chapter 3."<br>
            <span class="expected">Expected: Message appears immediately in learner's chat</span>
        </div>
        
        <div class="test-step">
            <strong>1.4 Verify on Tutor Side:</strong><br>
            ‚Ä¢ Switch to tutor browser<br>
            <span class="expected">Expected: Learner's message appears in real-time + notification</span>
        </div>

        <h3>Test 2: Real-Time Delivery</h3>
        <div class="test-step">
            <strong>2.1 Simultaneous Messaging:</strong><br>
            ‚Ä¢ Open both windows side by side<br>
            ‚Ä¢ Send messages rapidly back and forth<br>
            <span class="expected">Expected: All messages appear instantly, no delays</span>
        </div>

        <h3>Test 3: Message Persistence</h3>
        <div class="test-step">
            <strong>3.1 Refresh Test:</strong><br>
            ‚Ä¢ Send several messages between tutor and learner<br>
            ‚Ä¢ Refresh both pages<br>
            <span class="expected">Expected: All messages still visible, history preserved</span>
        </div>

        <h3>Test 4: Notification System</h3>
        <div class="test-step">
            <strong>4.1 Message Notifications:</strong><br>
            ‚Ä¢ Send message from tutor to learner<br>
            <span class="expected">Expected: Learner receives notification with sender name and preview</span><br>
            ‚Ä¢ Send message from learner to tutor<br>
            <span class="expected">Expected: Tutor receives notification with sender name and preview</span>
        </div>
    </div>

    <div class="test-container">
        <h2>üö® Common Issues & Solutions</h2>
        
        <div class="test-step">
            <strong>Issue: Messages not appearing</strong><br>
            <span class="warning">Solutions:</span><br>
            ‚Ä¢ Check WebSocket connection status<br>
            ‚Ä¢ Verify conversation room joining<br>
            ‚Ä¢ Check browser console for errors<br>
            ‚Ä¢ Ensure both users are in the same conversation
        </div>
        
        <div class="test-step">
            <strong>Issue: Messages not saving</strong><br>
            <span class="warning">Solutions:</span><br>
            ‚Ä¢ Check MongoDB connection<br>
            ‚Ä¢ Verify ChatMessage model validation<br>
            ‚Ä¢ Check database for saved messages<br>
            ‚Ä¢ Ensure conversation exists
        </div>
        
        <div class="test-step">
            <strong>Issue: Notifications not working</strong><br>
            <span class="warning">Solutions:</span><br>
            ‚Ä¢ Check notification service status<br>
            ‚Ä¢ Verify user notification preferences<br>
            ‚Ä¢ Check browser notification permissions<br>
            ‚Ä¢ Ensure notification types are correct
        </div>
    </div>

    <div class="test-container">
        <h2>üìä Test Results</h2>
        <div class="test-step">
            <input type="checkbox" id="test1"> Test 1: Basic Message Flow
        </div>
        <div class="test-step">
            <input type="checkbox" id="test2"> Test 2: Real-Time Delivery
        </div>
        <div class="test-step">
            <input type="checkbox" id="test3"> Test 3: Message Persistence
        </div>
        <div class="test-step">
            <input type="checkbox" id="test4"> Test 4: Notification System
        </div>
        <div class="test-step">
            <input type="checkbox" id="test5"> Test 5: Error Handling
        </div>
        <div class="test-step">
            <input type="checkbox" id="test6"> Test 6: Edge Cases
        </div>
        
        <button onclick="generateReport()">Generate Test Report</button>
        <div id="test-report"></div>
    </div>

    <div class="test-container">
        <h2>üîç Debug Information</h2>
        <h3>Backend Console Logs to Watch:</h3>
        <div class="test-step">
            <code>üîå User connected: [User Name] ([User ID])</code><br>
            <code>üí¨ [User Name] joining conversation: [Conversation ID]</code><br>
            <code>‚úÖ [User Name] joined conversation: [Conversation ID]</code><br>
            <code>üí¨ [User Name] sending message to conversation: [Conversation ID]</code><br>
            <code>‚úÖ Message sent by [User Name] to conversation: [Conversation ID]</code><br>
            <code>üì° Broadcasting message via Socket.IO: [Message Data]</code><br>
            <code>üîî Notification sent to [User Name] for message from [Sender Name]</code>
        </div>
        
        <h3>Frontend Console Logs to Watch:</h3>
        <div class="test-step">
            <code>üì® Loading messages for conversation: [Conversation ID]</code><br>
            <code>üì® Loaded messages data: [Response Data]</code><br>
            <code>üì® Loaded X valid messages out of Y total</code><br>
            <code>üì§ Sending message data: [Message Data]</code><br>
            <code>‚úÖ Message sent via WebSocket</code><br>
            <code>üì® Received Socket.IO message: [Message Data]</code><br>
            <code>üîî New notification received: [Notification Data]</code>
        </div>
    </div>

    <script>
        function checkBackend() {
            const statusDiv = document.getElementById('system-status');
            statusDiv.innerHTML = '<div class="status warning">Checking backend connection...</div>';
            
            fetch('http://localhost:5000/api/health')
                .then(response => {
                    if (response.ok) {
                        statusDiv.innerHTML = '<div class="status success">‚úÖ Backend is running and accessible</div>';
                    } else {
                        statusDiv.innerHTML = '<div class="status error">‚ùå Backend responded with error</div>';
                    }
                })
                .catch(error => {
                    statusDiv.innerHTML = '<div class="status error">‚ùå Backend is not accessible. Make sure it\'s running on port 5000</div>';
                });
        }
        
        function checkFrontend() {
            const statusDiv = document.getElementById('system-status');
            statusDiv.innerHTML = '<div class="status warning">Checking frontend connection...</div>';
            
            fetch('http://localhost:5173')
                .then(response => {
                    if (response.ok) {
                        statusDiv.innerHTML = '<div class="status success">‚úÖ Frontend is running and accessible</div>';
                    } else {
                        statusDiv.innerHTML = '<div class="status error">‚ùå Frontend responded with error</div>';
                    }
                })
                .catch(error => {
                    statusDiv.innerHTML = '<div class="status error">‚ùå Frontend is not accessible. Make sure it\'s running on port 5173</div>';
                });
        }
        
        function checkWebSocket() {
            const statusDiv = document.getElementById('system-status');
            statusDiv.innerHTML = '<div class="status warning">Checking WebSocket connection...</div>';
            
            try {
                const socket = new WebSocket('ws://localhost:5000');
                socket.onopen = function() {
                    statusDiv.innerHTML = '<div class="status success">‚úÖ WebSocket connection successful</div>';
                    socket.close();
                };
                socket.onerror = function() {
                    statusDiv.innerHTML = '<div class="status error">‚ùå WebSocket connection failed</div>';
                };
            } catch (error) {
                statusDiv.innerHTML = '<div class="status error">‚ùå WebSocket connection error: ' + error.message + '</div>';
            }
        }
        
        function generateReport() {
            const reportDiv = document.getElementById('test-report');
            const tests = ['test1', 'test2', 'test3', 'test4', 'test5', 'test6'];
            const testNames = [
                'Basic Message Flow',
                'Real-Time Delivery', 
                'Message Persistence',
                'Notification System',
                'Error Handling',
                'Edge Cases'
            ];
            
            let report = '<h3>Test Report:</h3>';
            let passed = 0;
            let total = tests.length;
            
            tests.forEach((testId, index) => {
                const isChecked = document.getElementById(testId).checked;
                if (isChecked) passed++;
                report += `<div class="test-step">${isChecked ? '‚úÖ' : '‚ùå'} ${testNames[index]}</div>`;
            });
            
            report += `<div class="test-step"><strong>Overall Result: ${passed}/${total} tests passed</strong></div>`;
            
            if (passed === total) {
                report += '<div class="status success">üéâ All tests passed! The messaging system is working perfectly.</div>';
            } else if (passed > total / 2) {
                report += '<div class="status warning">‚ö†Ô∏è Most tests passed, but some issues need attention.</div>';
            } else {
                report += '<div class="status error">‚ùå Multiple issues found. Please review the failed tests.</div>';
            }
            
            reportDiv.innerHTML = report;
        }
    </script>
</body>
</html>

